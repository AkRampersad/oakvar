<html>
<head>
	<script src="/result/js/jquery-3.2.1.min.js"></script>
    <script src="/result/js/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
    <link rel='stylesheet' href='/result/js/jquery-ui-1.12.1.custom/jquery-ui.css' />
	<script src='/result/nocache/js/util.js?ver=1.7.0'></script>
	<script src='/result/nocache/js/widgethelper.js?ver=1.7.0'></script>
	<script src='/result/js/packery.pkgd.js'></script>
	<script src='/result/js/graphics.js'></script>
	<script src='/result/js/raphael-min.js'></script>
	<link rel='stylesheet' href='/result/nocache/css/widget.css?ver=1.7.0' />
	<link rel='stylesheet' href='/result/nocache/css/variant.css?ver=1.7.0' />
    <title></title>
</head>
<body>

<div id='inputdiv'>
    <form name='input_form' method='GET'>
        <input id='input_chrom' name='inputChrom' />
        <input id='input_pos' name='inputPos' />
        <input id='input_ref' name='inputRef' />
        <input id='input_alt' name='inputAlt' />
        <input type='button' id='input_submit' name='input_submit' value='Annotate' onclick='submitForm(this.form);' />
    </form>
</div>
<div id='detaildiv_variant' class='detaildiv singlevariantpage' >
    <div id='detailcontainerwrapdiv_variant' class='detailcontainerwrapdiv' >
        <div id='detailcontainerdiv_variant' class='detailcontainerdiv' ></div>
    </div>
</div>

<script>
var CLOSURE_NO_DEPS = true;
var annotData = null;
var widgetContainerDiv = document.querySelector('#detailcontainerdiv_variant');

function getInputDataFromUrl () {
    var urlParams = new URLSearchParams(window.location.search);
    var inputChrom = urlParams.get('chrom');
    var inputPos = urlParams.get('pos');
    var inputRef = urlParams.get('ref_base');
    var inputAlt = urlParams.get('alt_base');
    var inputData = cleanInputData(inputChrom, inputPos, inputRef, inputAlt);
    return inputData;
}

function cleanInputData (inputChrom, inputPos, inputRef, inputAlt) {
    if (inputChrom == '') {
        inputChrom = null;
    }
    if (inputPos == '') {
        inputPos = null;
    }
    if (inputRef == '') {
        inputRef = null;
    }
    if (inputAlt == '') {
        inputAlt = null;
    }
    if (inputChrom == null || inputPos == null || inputRef == null || inputAlt == null) {
        return null;
    } else {
        return {'chrom': inputChrom, 'pos': inputPos, 'ref': inputRef, 'alt': inputAlt};
    }
}

function submitForm (form) {
    var inputData = cleanInputData(form.inputChrom.value, form.inputPos.value, form.inputRef.value, form.inputAlt.value);
    if (inputData != null) {
        submitAnnotate(inputData['chrom'], inputData['pos'], inputData['ref'], inputData['alt']);
    }
}

function submitAnnotate (inputChrom, inputPos, inputRef, inputAlt) {
    var url = '/submit/annotate';
    var params = {'chrom':inputChrom, 'pos':parseInt(inputPos), 'ref_base':inputRef, 'alt_base':inputAlt};
    $.ajax({
        type: 'POST',
        url: url,
        data: params,
        success: function (response) {
            annotData = response;
            annotData['base'] = annotData['crx'];
            showAnnotation(response);
        }
    });
}

function showWidget (widgetName, moduleNames, level) {
    var generator = widgetGenerators[widgetName];
    var divs = null;
    if (level != undefined) {
        divs = getDetailWidgetDivs(level, widgetName, widgetInfo[widgetName].title);
    } else {
        if ('variant' in generator) {
            divs = getDetailWidgetDivs('variant', widgetName, widgetInfo[widgetName].title);
            level = 'variant';
        } else if ('gene' in generator) {
            divs = getDetailWidgetDivs('gene', widgetName, widgetInfo[widgetName].title);
            level = 'gene';
        }
    }
    addEl(widgetContainerDiv, divs[0]);
    var data = {};
    for (var i = 0; i < moduleNames.length; i++) {
        var moduleName = moduleNames[i];
        var moduleData = annotData[moduleName];
        if (moduleData == null) {
            continue;
        }
        var moduleDataKeys = Object.keys(moduleData);
        for (var j = 0; j < moduleDataKeys.length; j++) {
            var key = moduleDataKeys[j];
            var value = moduleData[key];
            data[moduleName + '__' + key] = value;
        }
    }
    if (level == 'gene') {
        data['base__hugo'] = annotData['crx'].hugo;
    }
    console.log('@', widgetName, data);
    widgetGenerators[widgetName][level]['function'](divs[1], data, 'variant', true); // last true is to highlight if value exists.
}

function showAnnotation (response) {
    showWidget('base', ['base', 'dbsnp']);
    var generator = widgetGenerators['lollipop']['variant'];
    generator['width'] = 880;
    generator['height'] = 300;
    showWidget('lollipop', ['base']);
    showWidget('disasso', ['cgl', 'target', 'pubmed', 'clinvar', 'cgc', 'cosmic', 'grasp']);
    showWidget('popstat', ['thousand_genomes', 'gnomad', 'esp6500']);
    showWidget('ndex', ['ndex', 'base'], 'gene');
    showWidget('mupit2', ['base']);
    $(widgetContainerDiv).packery();
    var $widgets = $($(widgetContainerDiv).packery('getItemElements'));
    $widgets.draggable();
    $widgets.resizable();
}

function getWidgets (callback, callbackArgs) {
    $.get('/result/service/widgetlist', {}).done(function (jsonResponseData) {
        var tmpWidgets = jsonResponseData;
        var widgetLoadCount = 0;
        widgetGenerators = {};
        widgetInfo = {};
        for (var i = 0; i < tmpWidgets.length; i++) {
            var tmpWidget = tmpWidgets[i];
            var widgetName = tmpWidget['name'];
            var widgetNameNoWg = widgetName.substring(2);
            widgetInfo[widgetNameNoWg] = tmpWidget;
            $.getScript('/result/widgetfile/' + widgetName + '/' + widgetName + '.js', function () {
                widgetLoadCount += 1;
                if (widgetLoadCount == tmpWidgets.length) {
                    callback(callbackArgs);
                }
            });
        }
    });
}

var widgetInfo = {};
var widgetGenerators = {};

function processUrl () {
    var inputData = getInputDataFromUrl();
    if (inputData != null) {
        submitAnnotate(inputData['chrom'], inputData['pos'], inputData['ref'], inputData['alt']);
    }
}

function setSizes () {
    var detailDiv = document.querySelector('#detaildiv_variant');
    detailDiv.style.width = window.innerWidth;
    detailDiv.style.height = window.innerHeight;
}

function run () {
    setSizes();
    getWidgets(processUrl, null);
}

run();

</script>
</body>
</html>

